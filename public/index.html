<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" lang="de" xml:lang="de">
	<head>
		<!-- Meta Information -->
		<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />

		<!-- Title -->
		<title>Lounge Server</title>

		<!-- Cascading Stylesheet -->
		<style type="text/css" media="screen, projection">
			@import "css/global.css";			
		</style>
	    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v4.4.0.min.js"></script>
		
		<!-- Setup jQuery -->
		<script src ="./js/jquery-1.9.1.min.js"></script>
		
		<!-- Setup the socket.io functionality -->
		<script src="/socket.io/socket.io.js"></script>
		
		<script type="text/javascript" language="javascript" >
			/**
			 *	Validates a parameter.
			 */
		    var validateParameter = function(value)
		    {
		   		return ("undefined" === typeof value) ? "" : value;
		    };

			/**
			 *	Establishing a socket io connection.
			 */
			var socket = io.connect();

			/**
			 *	Global Variable to store the playerID.
			 */
			var globalPlayerID = '';

			/**
			 *	This method is called after the socket.io connection was successful established.
			 */
			socket.on('connect', function()
			{
				// Display the login user interface.
				// Add the username input.
				var usernameInput = $('<input/>',
				{
					id: 'username',
					value: 'username',
					type: 'text',
				});
				$("div#authentification").append(usernameInput);
				
				// Add the input button.								
				var inputButton = $('<input/>',
			    {
					id: 'login',
			        value: 'Login',
					type: 'submit',
			        click: function() 
					{
						var username = $("input#username").val();
						globalPlayerID = username;
						socket.emit('login', { playerID: username });
						return false;												
					}
			    });
				
				// Add the username input and the login button.
				$("div#authentification").append(inputButton);				
			});
			
			/**
			 *	This method is used for the chat functionality.
			 */
			socket.on('login', function(payload)
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.result))
				{
					if (payload.result)
					{
						if ('' !== validateParameter(payload.playerList))
						{
							// CheckIn the user.
							socket.emit('checkIn', { gameID: "andlabs.lounge.lobby", matchID: "andlabs.lounge.lobby" });							
							
							// Initialize Player List.
							$.each(payload.playerList, function(key, value) 
							{
								if ('' !== validateParameter(value.playerID) &&
									'' !== validateParameter(value.gameID));
								{
									if ('' !== validateParameter(value.matchID))
									{
  										$('div#connectedPlayer').append('<div class="player" playerID="' + value.playerID + '">' + value.playerID + '<div class="location">(' + value.gameID + ' | ' +  value.matchID+ ')</div></div>');
									}
									else
									{
									 	$('div#connectedPlayer').append('<div class="player" playerID="' + value.playerID + '">' + value.playerID + '<div class="location">(' + value.gameID + ')</div></div>');	
									}
								}
							});						

							// Remove the username and login button.
							$('div#authentification').empty();			  
							
							// Add the Logout Button.								
							var logoutButton = $('<input/>',
						    {
								id: 'logout',
						        value: 'Logout',
								type: 'submit',
						        click: function () 
								{
									socket.emit('logout');
									globalPlayerID = '';
									return false;														
								}
						    });
					
							$("div#authentification").append(logoutButton);
							
							// Add the create match functionality.
							var matchGameInput =  $('<input/>',
						    {
								id: 'matchGameID',
						        value: 'gameID',
								type: 'text'								
						    });
							
							$('div#createMatch').append(matchGameInput);
							
							var matchGameNameInput =  $('<input/>',
						    {
								id: 'matchGameName',
						        value: 'gameName',
								type: 'text'								
						    });
							
							$('div#createMatch').append(matchGameNameInput);
							
							var matchMaximumPlayerInput =  $('<input/>',
						    {
								id: 'matchMaximumPlayer',
						        value: 2,
								type: 'text'								
						    });
							
							$('div#createMatch').append(matchMaximumPlayerInput);		
							
							var matchStreamGameCheckbox = $('<input/>',
							{
								id: 'matchStreamGame',
								value: 'Stream Game',
								type: 'checkbox'
							});
							$('div#createMatch').append(matchStreamGameCheckbox);
							
							var matchCreateSubmit =  $('<input/>',
						    {
								id: 'matchCreateSubmit',
						        value: 'Create Match',
								type: 'submit',
						        click: function () 
								{
									var gameID = $("input#matchGameID").val();
									var gameName = $("input#matchGameName").val();
									var maximumPlayers = $("input#matchMaximumPlayer").val();
									var gameType = '';
									if ($("input#matchStreamGame").is(":checked"))
									{
										gameType = 'stream';
									}
									else
									{
										gameType = 'move';
									}
									socket.emit('join', { gameID: gameID, gameName: gameName, maximumPlayers: maximumPlayers, gameType: gameType });
									return false;														
								}														
						    });
							
							$('div#createMatch').append(matchCreateSubmit);	
											
							// Add the chat functionality.							
							var chatMessageInput =  $('<input/>',
						    {
								id: 'chatMessageInput',
						        value: 'chattext here',
								type: 'text'								
						    });							
							$('div#createChatMessage').append(chatMessageInput);		
							
							var chatMessageSubmit =  $('<input/>',
						    {
								id: 'chatMessageSubmit',
						        value: 'Send',
								type: 'submit',
						        click: function () 
								{
									var message = $("input#chatMessageInput").val();
									socket.emit('chat', { message: message });
									return false;													
								}														
						    });						
							$('div#createChatMessage').append(chatMessageSubmit);														
						}
					}
					else
					{
						globalPlayerID = '';
						var description = payload.description;
						if ('' !== validateParameter(description))
						{
							alert(description);
						}					
					}
				}
			});		
			
			/**
   			 *	This method is called after the user was disconnected.
			 */
			socket.on('disconnect', function () 
			{	
				// Reconnect to the server.
				socket.socket.connect();
				
				// Remove the logout button.
				$('div#authentification').empty();
				
				// Remove all open games.
				$('ul#openMatchesList').empty();
				
				// Remove all chat messages.
				$('div#chatMessages').empty();
				
				// Remove all running games.
				$('ul#runningMatchesList').empty();
				
				// Remove all online user.
				$('div#connectedPlayer').empty();
				
				// Remove the create match functionality.
				$('div#createMatch').empty();
				
				// Remove the chat functionality.
				$('div#createChatMessage').empty();
				
				// Remove the inspection window of an running match.				
				$('div.inspectGame').remove();
			});
			
			/**
			 *	This method gets called if a user authenticated successful.	
			 */
			socket.on('addPlayer', function(payload) 
			{
				if ('' !== validateParameter(payload) && 
					'' !== validateParameter(payload.playerID))
				{
  					$('div#connectedPlayer').append('<div class="player" playerID="' + payload.playerID + '">' + payload.playerID + '<div class="location"></div></div>');
				}
			});
			
			/**
			 *	This method gets called if a user did a logout.	
			 */
			socket.on('delPlayer', function(payload)
			{
				if ('' !== validateParameter(payload) && 
					'' !== validateParameter(payload.playerID))
				{
					$(".player[playerID = '" + payload.playerID + "']").remove();
				}
			});

			/**
			 *	This method is used for the chat callback.
			 */
			socket.on('chat', function(payload) 
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.result))
				{
					if (payload.result)
					{
						$('#chatMessageInput').val('');
					}
					else
					{
						if ('' !== validateParameter(payload.description))
						{
							alert(payload.description);
						}
					}
				}				
			});
			
			/**
			 *	This method is used to add a chat message.
			 */
			socket.on('addChatMessage', function(payload) 
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.playerID) &&
					'' !== validateParameter(payload.message))
				{
					$('#chatMessages').append('<div class="chatMessage">' + payload.playerID + ": " + payload.message + '</div>');
				}				
			});
						
			/**
			 *	This method is used for the join callback.
			 */
			socket.on('join', function(payload)
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.result) &&
					'' !== validateParameter(payload.description))
				{
					if (payload.result)
					{
						if ('create' === payload.description)
						{
							$("input#matchGameID").val('');
							$("input#matchGameName").val('');
							$("input#matchMaximumPlayer").val('');
						}
						else if ('join' == payload.description)
						{
							
						}
						else
						{
							alert('Wrong description for the success routine.');
						}
					}
					else
					{
						if ('' !== validateParameter(payload.description))
						{
							alert(payload.description);
						}
					}
				}				
			});
			
			/**
			 *	This method is called after a user creates a Match.
			 */
			socket.on('joinMatch', function(payload)
			{			
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.gameID) &&
					'' !== validateParameter(payload.matchID) &&
					'' !== validateParameter(payload.gameName) &&
				 	'' !== validateParameter(payload.totalSpots) &&
				 	'' !== validateParameter(payload.status) &&
					'' !== validateParameter(payload.gameType) &&
					'' !== validateParameter(payload.playerIDs))
				{					
					// Decide which status should be displayed
					if ('created' === payload.status ||
						'join' === payload.status)
					{
						
						// Create the match.
						var joinMatchSubmit = $('<input/>',
					    {
							class: 'joinMatchSubmit',
					        text: 'Join',
							matchID: payload.matchID,
							type: 'submit',
					        click: function () 
							{ 					
								socket.emit('join', { gameID: payload.gameID, matchID: payload.matchID });
							}
					    });

						var openSpots = payload.totalSpots - payload.playerIDs.length;
						
						// Check if the match is already in the list of open matches.
						if ($(".openMatch[matchID = '" + payload.matchID + "']").length > 0)
						{
							// Update the open spots. 
							$(".openMatch[matchID = '" + payload.matchID + "'] .openSpots").text(openSpots);
						}
						else
						{
							// Create the game.
							$("ul#openMatchesList").append("<li class='openMatch' matchID='" + payload.matchID + "'>" + payload.gameID+ "</b><br>" + payload.gameName + "<br>Match ID:" + payload.matchID + "<br>Game Type: " + payload.gameType + "<br>Open Spots:<div class='openSpots'>" + openSpots + "</div><br></li>");
						}	
					
						// Check if user is in the list of playerIDs.
						var foundPlayer = false;
						$.each(payload.playerIDs, function(key, value) {
							if (value.playerID === globalPlayerID)
							{
								foundPlayer = true;
							}
						});

						// Add or remove the joinMatchSubmit
						if (!foundPlayer)
						{
							$(".openMatch[matchID = '" + payload.matchID + "']").append(joinMatchSubmit);							
						}
						else
						{
							$(".openMatch[matchID = '" + payload.matchID + "'] .joinMatchSubmit").remove()
						}					
					}
					else if ('running' === payload.status)
					{
						// Remove the entry in the open games box.
						$(".openMatch[matchID = '" + payload.matchID + "']").remove();
						
						// Create the match.
						var inspectGameSubmit = $('<input/>',
					    {
							class: 'inspectGameSubmit',
					        value: 'inspectMatch',
							matchID: payload.matchID,
							type: 'submit',
					        click: function () 
							{ 				
								// Remove the old inspectGame div.
								$('.inspectGame').remove();
								
								// Display the new inspectGame div
								$('#wrapper').append('<div id="box" class="inspectGame" matchID="' + payload.matchID + '" style="margin-left: 20px;"><div id="box_cont" style="background-color: rgb(23, 200, 200);"></div></div>');
								
								// Create a button to close the current inspected match window.
								var closeInspectMatchWindowSubmit = $('<input/>', 
								{
									class: 'closeInspectMatchWindowSubmit',
									value: 'closeMatchWindow',
									type: 'submit',
									click: function ()
									{
										// Remove the old inspectGame div.
										$('.inspectGame').remove();
										
										// CheckIn the user.
										socket.emit('checkIn', { gameID: "andlabs.lounge.lobby", matchID: "andlabs.lounge.lobby" });
									}
								});
								
								// Add the button to the inspectMatchBox.
								$('.inspectGame[matchID = "' + payload.matchID + '"] #box_cont').append(closeInspectMatchWindowSubmit);
								
								// Create a button to close the current inspected match.
								var closeInspectMatchSubmit = $('<input/>', 
								{
									class: 'closeInspectMatchSubmit',
									value: 'closeMatch/Finish',
									type: 'submit',
									click: function ()
									{
										// CheckIn the user.
										socket.emit('update', { gameID: payload.gameID, matchID: payload.matchID, status: "close" });
									}
								});
								
								// Add the button to the inspectMatchBox.
								$('.inspectGame[matchID = "' + payload.matchID + '"] #box_cont').append(closeInspectMatchSubmit);
															
								// Update the user status.
								socket.emit('checkIn', {gameID: payload.gameID, matchID: payload.matchID});
								
								// Decide which game type we are playing.
								if ('move' === payload.gameType)
								{
									// Receive last move.
									socket.emit('lastMove', { gameID: payload.gameID, matchID: payload.matchID });
								}
								else if ('stream' === payload.gameType)
								{
									// Create the canvas
									var canvas = $('<div/>',
									{
										id: 'ballCanvas',
										'style': 'width: 250px; height: 300px; background-color: white;',
									});
									
									// Prepare the ui for the ball game.
									$('.inspectGame[matchID = "' + payload.matchID + '"] #box_cont').append(canvas);
							
									var color = createRandomColor();
									canvas.mousemove(function(event)
									{
										
										var rect = canvas[0].getBoundingClientRect();
										var x = event.clientX - rect.left;
										var y = event.clientY - rect.top;
/*
										var context = canvas[0].getContext('2d');
										context.beginPath();
										context.arc(x, y, 5, 0, 2 * Math.PI, false);
										context.fillStyle = 'red';
										context.fill();*/

										socket.emit('stream', {gameID: payload.gameID, matchID: payload.matchID, move: {x: x, y: y, color: color}});
										paintBall(payload.gameID, payload.matchID, x, y, color);
									});	
								}
							}
					    });						
						
						// Remove the old state in open games.
						if ($(".runningMatch[matchID = '" + payload.matchID + "']").length === 0)
						{
							$("ul#runningMatchesList").append('<li class="runningMatch" matchID="' + payload.matchID + '">GameID: ' + payload.gameID + '<br>MatchID: ' + payload.matchID + '<br>GameName: ' + payload.gameName + '<br> Player: <div class=' + payload.matchID + '></div></li>')					
							$.each(payload.playerIDs, function(key, value) {
								$('.' + payload.matchID).append(value.playerID + ' ');
							});												
							
							// Check if user is in the list of playerIDs.
							var foundPlayer = false;
							$.each(payload.playerIDs, function(key, value) {
								if (value.playerID === globalPlayerID)
								{
									foundPlayer = true;
								}
							});

							// Add or remove the joinMatchSubmit
							if (foundPlayer)
							{
								$(".runningMatch[matchID = '" + payload.matchID + "']").append(inspectGameSubmit);							
							}
							else
							{
								$(".runningMatch[matchID = '" + payload.matchID + "'] .inspectGameSubmit").remove()
							}
						}
					}
					else if ('close' === payload.status)
					{	
						// Remove the entry in the open games box.
						$(".openMatch[matchID = '" + payload.matchID + "']").remove();
						
						// Remove the entry in the running games box.
						$(".runningMatch[matchID = '" + payload.matchID + "']").remove();
						
						// Remove the game div if it is currently visible
						if ($(".inspectGame[matchID  = '" + payload.matchID + "']").length > 0 )
						{
							$(".inspectGame[matchID  = '" + payload.matchID + "']").remove();
							
							// CheckIn to Lobby.
							socket.emit('checkIn', { gameID: "andlabs.lounge.lobby", matchID: "andlabs.lounge.lobby" });							
						}
					}					
				}
			});	
		
			/**
			 *	This method is the user callback after the attempt of a match move.
			 */
			socket.on('move', function(payload)
			{
				// Handle the move callback after successful match move.
			});
			
			/**
			 *	This method is called after a user did a match move.
			 */
			socket.on('moveMatch', function(payload)
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.gameID) &&
					'' !== validateParameter(payload.matchID) &&
					'' !== validateParameter(payload.move))
				{
					handleMove(payload.gameID, payload.matchID, payload.move);
				}
			});
			
			/**
			 *	This is the callback after an user updates a match status.
			 */
			socket.on('update', function(payload)
			{
				// Handle a update match callback.
			});			
			
			/**
			 *	This is the callback if the user is performing a checkIn.
			 */
			socket.on('checkIn', function(payload)
			{
				// Handle checkIn callback.
			});
			
			/**
			 *	This method is called after an user did a checkIn.
			 */
			socket.on('checkInUser', function(payload)
			{
				if ( '' !== validateParameter(payload) &&
					 '' !== validateParameter(payload.gameID) &&
					 '' !== validateParameter(payload.playerID))
				{
					if ('' !== validateParameter(payload.matchID))
					{
						$('.player[playerID = "' + payload.playerID + '"] div.location').text('(' + payload.gameID + ' | ' + payload.matchID + ')');
					}
					else
					{
						if ('andlabs.lounge.lobby' === payload.gameID)
						{
							$('.player[playerID = "' + payload.playerID + '"] div.location').text('(' + payload.gameID + ')');
						}
					}
				}
			});
			
			/**
			 *	User receives the last move for a specific matchID.
			 */
			socket.on('lastMove', function(payload)
			{
				if ('' !== validateParameter(payload) &&
					'' !== validateParameter(payload.result))
				{
					if (payload.result)
					{
						if ('' !== validateParameter(payload.gameID) &&
							'' !== validateParameter(payload.matchID))
						{
							createInspectionInputFields(payload.gameID, payload.matchID);
							createInspectionSubmit(payload.gameID, payload.matchID);
							createLastMoveArea(payload.gameID, payload.matchID);
							
							if ('' !== validateParameter(payload.move))
							{
								handleMove(payload.gameID, payload.matchID, payload.move);
							}
							else
							{
								handleEmptyMove(payload.gameID, payload.matchID);
							}
						}
					}
					else
					{
						if ('' !== validateParameter(payload.description))
						{
							alert(payload.description);
						}
					}
				}
			});
			
			/**
			 *	Receive a stream package.
			 */
			socket.on('stream', function(payload)
			{
				if ( '' !== validateParameter(payload) &&
					 '' !== validateParameter(payload.gameID) &&
					 '' !== validateParameter(payload.matchID) &&
				 	 '' !== validateParameter(payload.move))
				{
					// Ball Game
					var move = payload.move;
					if ('' !== move.x &&
						'' !== move.y &&
						'' !== move.color)
					{
						paintBall(payload.gameID, payload.matchID, move.x, move.y, move.color);
					}
				}
			});
			
			/**
			 *	Handle a move
			 */
			var handleMove = function(gameID, matchID, move)
			{
				if (!move)
				{
					return;
				}

				// Remove the old move.
				$('.inspectGame[matchID = "' + matchID + '"] #box_cont .currentMove').empty();
				
				var JSONObj = $.parseJSON(move)
				$.each(JSONObj, function(key, value)
				{
					$('.inspectGame[matchID = "' + matchID + '"] #box_cont .currentMove').append(key + " --> " + value + "<br>")
				});								
			}			
			
			/**
			 *	Create empty key/value input fields.
			 */
			var createInspectionInputFields = function(gameID, matchID)
			{
				for (var i = 0; i < 8; i++)
				{
					var div = $('<div/>',
					{
						 class:'inspectionInput'
					});
					
					var key = $('<input/>', 
					{
						class: 'inspectionInputKey' + i,
						value: 'key',
						type: 'text'
					});
					var value = $('<input/>', 
					{
						class: 'inspectionInputValue' + i,
						value: 'value',
						type: 'text'
					});	
					$('.inspectGame[matchID = "' + matchID + '"] #box_cont').append(div)
					div.append(key);					
					div.append(value);					
				}			
			}
			
			/**
			 *	Create the inspection submit field.
			 */
			var createInspectionSubmit = function(gameID, matchID)
			{					
				// Create a button to close the current inspected match.
				var createInspectionSubmit = $('<input/>', 
				{
					class: 'createInspectionSubmit',
					value: 'Send',
					type: 'submit',
					click: function ()
					{
						var jsonObj = {};
						var createPkg = false;
						
						// CheckIn the user.
						$('.inspectGame[matchID = "' + matchID + '"] #box_cont .inspectionInput').each(function(key, val)
						{
							var k = $('.inspectGame[matchID = "' + matchID + '"] #box_cont .inspectionInput .inspectionInputKey' + key );
							var v = $('.inspectGame[matchID = "' + matchID + '"] #box_cont .inspectionInput .inspectionInputValue' + key );

							if ('key' !== k.val() &&
								'value' !== v.val() &&
								'' !== k.val())
							{
								jsonObj[k.val()] = v.val();
								createPkg = true;
							}
						});
						var myString = JSON.stringify(jsonObj);
						
						if (createPkg)
						{
							socket.emit('move', {gameID: gameID, matchID: matchID, move: myString})
						}
					}
				});
				$('.inspectGame[matchID = "' + matchID + '"] #box_cont').append(createInspectionSubmit);	
			}
			
			/**
			 *	Create the last move area.
			 */
			var createLastMoveArea = function(gameID, matchID)
			{
				// Add the new move.
				var div = $('<div/>',
				{
					class: 'currentMove'
				});
				$('.inspectGame[matchID = "' + matchID + '"] #box_cont').append(div);
			}
			
			/**
			 * Create a random color.
			 */
			var createRandomColor = function () 
			{
			    var letters = '0123456789ABCDEF'.split('');
			    var color = '#';
			    for (var i = 0; i < 6; i++ ) 
				{
			        color += letters[Math.round(Math.random() * 15)];
			    }
			    return color;
			}
			
			/**
			 *	Paint the ball.
			 */
			var paintBall = function(gameID, matchID, x, y, color)
			{
				var context = canvas[0].getContext('2d');
				context.beginPath();
				context.arc(x, y, 5, 0, 2 * Math.PI, false);
				context.fillStyle = 'red';
				context.fill();*/
			}
		</script>		
	</head>
<body>

	<div id="wrapper">
		<div id="header"><h1><strong>Lounge Server</strong> - Android Web Debug Client v0.8</h1>
			<div id="authentification">
			</div>
		</div>


		<!-- Open Matches -->
		<div id="box">
			<div id="box_cont" style="background-color: rgb(144, 71, 44);">
				<strong>Open Matches.</strong> 
				<ul id="openMatchesList">
					<!-- Listelement --> 
					<li>
						<div id="joinbutton">Join</div>
						<b>Player Name A</b><br>
						Gamename
					</li>
					<!-- Listelement end--> 
					<!-- Listelement --> 
					<li>
						<div id="joinbutton">Join</div>
						<b>Player Name A</b><br>
						Gamename
					</li>
					<!-- Listelement end--> 
				</ul>
			</div>
			<div id="createMatch">
			</div>
		</div>
		
		<!-- Chat -->
		<div id="box" style="margin-left: 20px;">
			<div id="box_cont" style="background-color: rgb(21, 68, 82);">
				<strong>Chat</strong> 
				<div id="chatMessages">
				</div>
			</div>
			<div id="createChatMessage">
			</div>
		</div>

		<!-- Running Matches  -->
		<div id="box" style="margin-left: 20px;">
			<div id="box_cont" style="background-color: rgb(21, 95, 64);">
				<strong>Running matches.</strong> 
				<ul id="runningMatchesList">
					<!-- Listelement --> 
					<li>
						GameID: <strong>12345678</strong><br>
						Game: <strong>thatgamemon!</strong><br>
						Players: <strong>yo, gangsta, pibbedipit</strong><br>
					</li>
					<!-- Listelement end--> 
				</ul>	
			</div>
			<div id="box_bottom"> Output / Server Log</div>
		</div>
		
		<!-- Online Player -->
		<div id="box" style="margin-left: 20px;">		
			<div id="box_cont" style="background-color: rgb(146, 139, 21);">
				<strong>Players logged in.</strong> 
				<div id="connectedPlayer">
				</div>
			</div>		
		</div>		
	</div>	
</body>
</html>